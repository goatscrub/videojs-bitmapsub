/*! @name videojs-bitmapsub @version 1.0.0 @license MIT */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).videojsBitmapsub=e()}(this,(function(){"use strict";const t=videojs.getComponent("Component"),e=videojs.getPlugin("plugin"),i=videojs.getComponent("MenuButton"),s=videojs.getComponent("MenuItem"),n=videojs.getComponent("TextTrackMenuItem");class a extends i{createItems(){if(this.menuItems)return this.menuItems;const{bitmapTracks:t=[]}=this.options_;return t||void 0}}class l extends t{createEl(){const t=videojs.dom.createEl("div",{className:"bitmapsub-container"}),e=videojs.dom.createEl("div",{className:"bitmap-subtitle"});return t.appendChild(e),t}}class r extends e{constructor(t,e){super(t,e),this.player=t,this.options=videojs.obj.merge({pathPrefix:"/bitmapsub/",labelPrefix:"",labelSuffix:" â‹…BMP",name:"bitmapsub"},e),this.buildDynamicStyle();const i=[...document.styleSheets].find((t=>t.ownerNode.id===`css-bitmap-${this.player.id()}`)).cssRules;this.bmpSubtitleContainerStyle=[...i].find((t=>t.selectorText===`#${this.player.id()} .bitmapsub-container`)).style,this.bitmapTracks=[],this.currentSubtitle={listener:!1,track:!1},this.player.on("loadeddata",(t=>{this.appendComponent(),this.updateBitmapMenu(),this.scaleBmpSubtitleContainer()})),this.player.on("fullscreenchange",this.adjustSubtitlePosition.bind(this)),this.player.on("playerresize",this.scaleBmpSubtitleContainer.bind(this)),this.player.one("play",(t=>{this.ctrlBarHeight=this.player.controlBar.height(),this.bmpSubtitleContainerStyle.setProperty("--control-bar-height",`${this.ctrlBarHeight}px`)}))}buildDynamicStyle(){const t=document.createElement("style"),e=this.player.id();return t.id=`css-bitmap-${e}`,t.textContent=`#${e} .bitmapsub-container{}`,document.head.appendChild(t),t}appendComponent(){this.bmpSubContainer=new l(this.player,this.options),this.player.addChild(this.bmpSubContainer),this.subtitleElement=this.bmpSubContainer.el().querySelector(`#${this.player.id()} .bitmap-subtitle`),this.bitmapMenu=new a(this.player,{name:"bitmapMenuButton"}),this.bitmapMenu.addClass("vjs-subtitles-button");const t=this.player.controlBar.children().indexOf(this.player.controlBar.getChild("SubsCapsButton"))+1;this.player.controlBar.addChild(this.bitmapMenu,null,t)}updateBitmapMenu(){this.bitmapTracks=this.getBitmapTracks(),this.bitmapMenu.menuItems=this.buildTrackMenuItems(),this.bitmapMenu.update()}getBitmapTracks(){const t=this.player.textTracks(),e=[];for(let i=0;i<t.length;i++)"metadata"===t[i].kind&&t[i].label.match(/^(pgssub|vobsub):(\d+):/)&&e.push(t[i]);return e}menuControlItems(){const t=new s(this.player,{label:"Bitmap Off",name:"bitmap-off",id:"bitmap-off"});return t.handleClick=()=>{this.player.controlBar.getChild("BitmapMenuButton").menu.children().forEach((t=>{t.removeClass("vjs-selected")})),this.bitmapTracks.forEach((t=>{t.mode="disabled"})),t.addClass("vjs-selected"),this.bmpSubContainer.hide(),this.listenCueChange(!1)},[t]}setBmpSubContainerClass(t){"pgssub"===t?(this.bmpSubContainer.removeClass("vobsub"),this.bmpSubContainer.addClass("pgssub")):(this.bmpSubContainer.addClass("vobsub"),this.bmpSubContainer.removeClass("pgssub"))}buildTrackMenuItems(){let t=[];return this.bitmapTracks.map((e=>{const i=new n(this.player,{label:this.options.labelPrefix+e.label.split(":")[2]+this.options.labelSuffix,track:{label:this.options.labelPrefix+e.label.split(":")[2]+this.options.labelSuffix,language:e.language,id:e.id,default:e.default}});e.bitmapsub={width:e.label.split(":")[1]};const s=e.label.split(":")[0];e.default?(e.mode="hidden",this.currentSubtitle.track=e,this.selectMenuItem(i),this.listenCueChange(),this.setBmpSubContainerClass(s)):e.mode="disabled",i.handleClick=()=>{this.selectMenuItem(i),this.changeToTrack(i.track.id),this.setBmpSubContainerClass(s)},t.push(i)})),t.length&&(t=[...this.menuControlItems(),...t]),t}scaleBmpSubtitleContainer(){if(!this.currentSubtitle.track)return;const t=(this.player.textTrackDisplay.dimension("width")/this.currentSubtitle.track.bitmapsub.width).toFixed(2);this.bmpSubContainer.el().style.scale=`${t}`,this.adjustSubtitlePosition()}deselectMenuItem(){this.player.controlBar.getChild("bitmapMenuButton").menu.children().forEach((t=>t.removeClass("vjs-selected"))),this.bmpSubContainer.hide()}selectMenuItem(t){this.deselectMenuItem(),this.bmpSubContainer.show(),t.addClass("vjs-selected")}handleBitmapSubtitle(){if(this.currentSubtitle.track.activeCues.length){const[t,e,i,s,n]=this.currentSubtitle.track.activeCues[0].text.split(":");let a;a=`width:${e}px;height:${i}px;background-image:url(${[this.options.pathPrefix,t].join("/")});`,a=`${a}background-position-x:-${s}px;background-position-y:-${n}px`,this.subtitleElement.style=a,this.bmpSubContainer.el().style.opacity=1}else this.bmpSubContainer.el().style.opacity=0}listenCueChange(t=!0){t?(this.currentSubtitle.track.addEventListener("cuechange",this.handleBitmapSubtitle.bind(this)),this.currentSubtitle.listener=!0):this.currentSubtitle.listener&&(this.currentSubtitle.track.removeEventListener("cuechange",this.handleBitmapSubtitle),this.currentSubtitle.listener=!1)}changeToTrack(t){this.bitmapTracks.forEach((e=>{e.id===t?(e.mode="hidden",this.listenCueChange(!1),this.currentSubtitle.track=e,this.listenCueChange()):e.mode="disabled"}))}adjustSubtitlePosition(){let t=this.player.textTrackDisplay.height()/32;if(this.player.isFullscreen()){const e=Math.round(this.player.textTrackDisplay.getPositions().boundingClientRect.y);e<this.ctrlBarHeight?t+=this.ctrlBarHeight-e:t+=e}t*=window.devicePixelRatio,this.bmpSubtitleContainerStyle.setProperty("--drift",`${t}px`)}}return r.VERSION="1.0.0",videojs.registerComponent("bitmapSubtitleContainer",l),videojs.registerComponent("bitmapMenuButton",a),videojs.registerPlugin("bitmapSubtitle",r),r}));
